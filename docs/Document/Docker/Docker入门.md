# Docker å…¥é—¨

## ç›¸å…³ç½‘å€

Docker å®˜ç½‘ï¼šhttps://www.docker.com

docker åº“ï¼šhttps://hub.docker,com

## Docker ç®€ä»‹

Docker æ˜¯ä¸€ç§å®¹å™¨åŒ–å¹³å°ï¼Œå…è®¸å¼€å‘äººå‘˜å°†åº”ç”¨ç¨‹åºåŠå…¶æ‰€æœ‰ä¾èµ–é¡¹æ‰“åŒ…åˆ°ä¸€ä¸ªç§°ä¸º Docker é•œåƒçš„å¯ç§»æ¤å®¹å™¨ä¸­ã€‚è¿™ä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä»¥ç›¸åŒçš„æ–¹å¼è¿è¡Œï¼Œè€Œæ— éœ€æ‹…å¿ƒç¯å¢ƒå·®å¼‚æˆ–ä¾èµ–é—®é¢˜ã€‚

Docker æ˜¯ä¸€ä¸ªå¼€æºçš„å¼•æ“ï¼Œå¯ä»¥è½»æ¾çš„ä¸ºä»»ä½•åº”ç”¨åˆ›å»ºä¸€ä¸ªè½»é‡çº§çš„ã€å¯ç§»æ¤çš„ã€è‡ªç»™è‡ªè¶³çš„å®¹å™¨ã€‚å¼€å‘è€…åœ¨ç¬”è®°æœ¬ä¸Šç¼–è¯‘æµ‹è¯•é€šè¿‡çš„å®¹å™¨å¯ä»¥æ‰¹é‡åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²ï¼ŒåŒ…æ‹¬ VMs (è™šæ‹Ÿæœº) ã€bare metalã€OpenStack é›†ç¾¤å’Œå…¶ä»–çš„åŸºç¡€åº”ç”¨å¹³å°ã€‚

Docker é€šå¸¸ç”¨äºå¦‚ä¸‹åœºæ™¯ï¼š

- web åº”ç”¨çš„è‡ªåŠ¨åŒ–æ‰“åŒ…å’Œå‘å¸ƒ ;
- è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒæŒç»­é›†æˆã€å‘å¸ƒï¼›
- åœ¨æœåŠ¡å‹ç¯å¢ƒä¸­éƒ¨ç½²å’Œè°ƒæ•´æ•°æ®åº“æˆ–å…¶ä»–çš„åå°åº”ç”¨ï¼›
- ä»å¤´ç¼–è¯‘æˆ–è€…æ‰©å±•ç°æœ‰çš„ OpenShift æˆ– Cloud Foundry å¹³å°æ¥æ­å»ºè‡ªå·±çš„ PaaS ç¯å¢ƒã€‚

## å¾®æœåŠ¡çš„æ ¸å¿ƒæ€æƒ³

## Docker vs VM

VMï¼š

- è¿è¡Œåœ¨å®¿ä¸»æœºä¹‹ä¸Šçš„å®Œæ•´çš„æ“ä½œç³»ç»Ÿ
- è¿è¡Œè‡ªèº«æ“ä½œç³»ç»Ÿä¼šå ç”¨è¾ƒå¤šçš„èµ„æº

Docker :

- Docker æ›´åŠ è½»é‡é«˜æ•ˆ
- å¯¹ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡å¾ˆé«˜
- æ¯”è™šæ‹ŸæœºæŠ€æœ¯æ›´ä¸ºè½»ä¾¿ã€å¿«æ·
- éš”ç¦»æ•ˆæœä¸å¦‚ VM

## Docker çš„ç›¸å…³æ¦‚å¿µ

Docker æ˜¯ CS æ¶æ„ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ¦‚å¿µ

Docker daemon:

- è¿è¡Œåœ¨å®¿ä¸»æœºä¸Š
- Docker å®ˆæŠ¤è¿›ç¨‹
- ç”¨æˆ·é€šè¿‡ Docker client(Docker å‘½ä»¤)ä¸ Docker daemon äº¤äº’

Docker client:

- Docker å‘½ä»¤è¡Œå·¥å…·ï¼Œæ˜¯ç”¨æˆ·ä½¿ç”¨ Docker çš„ä¸»è¦æ–¹å¼
- Docker client ä¸ Docker daemon é€šä¿¡å¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·
- Docker client ä¹Ÿå¯ä»¥é€šè¿‡ socket æˆ–è€… RESTful api è®¿é—®è¿œç¨‹çš„ Docker daemon

## å®‰è£…ä¸ Hello world

## å¸¸ç”¨å‘½ä»¤ä¸ Dockerfile

Dockerfile æ¦‚å¿µ

Dockerfile æ–‡ä»¶æ ¼å¼

æ„å»ºé•œåƒ

é•œåƒæ ‡ç­¾

ä¿®æ”¹å®¹å™¨å†…å®¹

## Docker Hub

docker åº“ï¼šhttps://hub.docker,com

## å®æˆ˜ :æ‰“åŒ…ä¸€ä¸ª WEB æœåŠ¡å™¨

## å¾®æœåŠ¡åˆ°åº•æ˜¯ä»€ä¹ˆ

å¾®æœåŠ¡å±äºæ¶æ„å±‚é¢çš„è®¾è®¡æ¨¡å¼

å¾®æœåŠ¡çš„è®¾è®¡æ¦‚å¿µä»¥ä¸šåŠ¡åŠŸèƒ½ä¸ºä¸»

å¾®æœåŠ¡ç‹¬ç«‹æä¾›å¯¹åº”çš„ä¸šåŠ¡åŠŸèƒ½

å¾®æœåŠ¡ä¸æ‹˜æ³¥äºå…·ä½“çš„å®ç°è¯­è¨€

å¾®æœåŠ¡æ¶æ„ ~ æ¨¡å—åŒ–å¼€å‘ + åˆ†å¸ƒå¼è®¡ç®—

å¾®æœåŠ¡ä¸€ä¸€é›†æˆä¸éƒ¨ç½²

- æŒç»­é›†æˆä¸€ jekins
- è™šæ‹ŸåŒ–ä¸€ä¸€è™šæ‹Ÿæœº
- å®¹å™¨-Docker

## K8S(Kubernetes)å…¥é—¨

å®˜ç½‘ï¼šhttps://www.kubernetes.org.cn/k8s

### ä»€ä¹ˆæ˜¯ K8s

- Kubernetesï¼Œå› ä¸ºé¦–å°¾å­—æ¯ä¸­é—´æœ‰ 8 ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥è¢«ç®€å†™æˆ K8sã€‚
- k8s æ˜¯åº•å±‚èµ„æºä¸å®¹å™¨é—´çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå¦‚æœå’Œå•æœºæ¶æ„ç±»æ¯”ï¼Œå¯ä»¥ç®—ä½œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ—¶ä»£çš„ Linuxã€‚
- K8s æ˜¯ Google å¼€æºçš„å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿã€‚åœ¨ Docker æŠ€æœ¯çš„åŸºç¡€ä¸Šï¼Œä¸ºå®¹å™¨åŒ–çš„åº”ç”¨æä¾›éƒ¨ç½²è¿è¡Œã€èµ„æºè°ƒåº¦ã€æœåŠ¡å‘ç°å’ŒåŠ¨æ€ä¼¸ç¼©ç­‰ä¸€ç³»åˆ—å®Œæ•´åŠŸèƒ½ï¼Œæé«˜äº†å¤§è§„æ¨¡å®¹å™¨é›†ç¾¤ç®¡ç†çš„ä¾¿æ·æ€§ã€‚

### K8S çš„ç‰¹ç‚¹

k8s æ˜¯ä¸€ä¸ªç®¡ç†å®¹å™¨çš„å·¥å…·ï¼Œä¹Ÿæ˜¯ç®¡ç†åº”ç”¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªå·¥å…·åº”ç”¨æ›´æ–°ä»åˆ›å»ºåº”ç”¨ï¼Œåº”ç”¨çš„éƒ¨ç½²ï¼Œåº”ç”¨æä¾›æœåŠ¡ï¼Œæ‰©å®¹ç¼©å®¹åº”ç”¨ï¼Œè€Œä¸”å¯ä»¥åšåˆ°æ•…éšœè‡ªæ„ˆã€‚

- å¯ç§»æ¤ï¼šæ”¯æŒå…¬æœ‰äº‘ï¼Œç§æœ‰äº‘ï¼Œæ··åˆäº‘
- å¯æ‰©å±•ï¼šæ¨¡å—åŒ–ï¼Œçƒ­æ’æ‹¨ï¼Œå¯ç»„åˆ
- è‡ªæ„ˆï¼šè‡ªåŠ¨æ›¿æ¢ï¼Œè‡ªåŠ¨é‡å¯ï¼Œè‡ªåŠ¨å¤åˆ¶ï¼Œè‡ªåŠ¨æ‰©å±•

### K8S çš„ç®¡ç†æ­¥éª¤

åœ¨ k8s è¿›è¡Œç®¡ç†åº”ç”¨çš„æ—¶å€™ï¼ŒåŸºæœ¬æ­¥éª¤æ˜¯ï¼š

1. åˆ›å»ºé›†ç¾¤
2. éƒ¨ç½²åº”ç”¨
3. å‘å¸ƒåº”ç”¨
4. æ‰©å±•åº”ç”¨
5. æ›´æ–°åº”ç”¨

### K8S çš„æ¶æ„ç»“æ„

- ç”Ÿæ€ç³»ç»Ÿ
- æ¥å£å±‚
- ç®¡ç†å±‚
- åº”ç”¨å±‚
- æ ¸å¿ƒå±‚

### å®‰è£… K8S

åœ¨ Linux ä¸‹å®‰è£…å•æœºç‰ˆçš„é›†ç¾¤ç¯å¢ƒ

ä»¥ root èº«ä»½æ‰§è¡Œä»¥ä¸‹æ“ä½œ :

1ã€å…³é—­ Linux é˜²ç«å¢™

- systemctI stop firewalld
- systemctl disable firewalld

2ã€å®‰è£… Kubernetes å’Œä¾èµ–ç»„ä»¶ etcd

- yum install -y etcd kubernetes

3ã€ä¿®æ”¹é…ç½®

- Docker é…ç½®æ–‡ä»¶ï¼š`/etc/sysconfig/docker`ï¼Œ`OPTIONS=''--selinux-enabled=false --insecure-registry gcr.io'`
- Kubernetes apiservce é…ç½®æ–‡ä»¶ï¼š`/etc/kubernetes/apiserver`ï¼ŒæŠŠ --admission-control å‚æ•°ä¸­çš„ ServiceAccount åˆ é™¤

4ã€æŒ‰é¡ºåºå¯åŠ¨æ‰€æœ‰çš„æœåŠ¡

- systemctl start etcd
- systemctl start docker
- systemctl start kube-apiserver
- systemctl start kube-controller-manager
- systemctl start kube-scheduler
- systemctl start kubelet
- systemctl start kube-proxy

# portainerï¼šå°† Dockerã€Docker-composeã€Kubernetes ä¸‰è€…ç»Ÿä¸€ç®¡ç†çš„å¹³å°

è‡ª 2013 å¹´å‘å¸ƒä»¥æ¥ï¼ŒDocker è·å¾—äº†å¹¿æ³›çš„å…³æ³¨å’Œåº”ç”¨ã€‚åœ¨è¿‡å»çš„è¿‘åå¹´ä¸­ï¼ŒDocker ä¹Ÿé€æ¸æ”¹å˜äº†è½¯ä»¶å¼€å‘å’Œéƒ¨ç½²çš„æ–¹å¼ï¼Œè‡³ä»Šé‡‡ç”¨å®¹å™¨å·²ç»æˆä¸ºå¾ˆå¤šä¼ä¸šè½¯ä»¶æ ‡å‡†çš„è§„èŒƒä¹‹ä¸€ã€‚ä»å•æœºçš„ Dockerï¼Œåˆ°å•æœºç¼–æ’çš„ Docker-composeï¼Œå†åˆ°é›†ç¾¤ç¼–æ’è°ƒåº¦çš„ Docker-Swarm å’Œ Kubernetesï¼Œåœ¨è¿™åå¹´ä¸­å®¹å™¨çš„æŠ€æœ¯ä¹Ÿå‘ç”Ÿäº†å¾ˆå¤šçš„å˜åŒ–ï¼Œéšç€ Docker-Swarm çš„è½è´¥ï¼ŒKubernetes æˆä¸ºå®¹å™¨ç¼–æ’æ ‡å‡†ã€‚ç»“åˆä¼ä¸šè‡ªèº«ä¸šåŠ¡ï¼Œå¾ˆå¤šä¼ä¸šç›®å‰é¢å‘ä¸åŒçš„åœºæ™¯å¯¹å®¹å™¨çš„ä½¿ç”¨å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§åœºæ™¯ï¼š

- **Docker ç‹¬ç«‹ä½¿ç”¨:**ä¸»è¦ç”¨äºåˆ›å»ºå’Œç®¡ç†å•ä¸ªå®¹å™¨ã€‚å¯¹äºå•ä¸ªåº”ç”¨å’Œæµ‹è¯•åº”ç”¨éƒ¨ç½²éå¸¸ä¾¿æ·é«˜æ•ˆã€‚
- **Docker-compose æœåŠ¡æ¨¡å¼ï¼š**ä¸»è¦ç”¨äºåˆ›å»ºå’Œç®¡ç†å¤šå®¹å™¨åº”ç”¨ï¼Œå¯ä»¥è½»æ¾åœ°å¯åŠ¨ã€åœæ­¢ã€é‡æ–°éƒ¨ç½²æ•´ä¸ªæœåŠ¡ã€‚
- **Kubernetes é›†ç¾¤è°ƒåº¦ï¼š**ç”¨äºç®¡ç†å’Œè°ƒåº¦ç¼–æ’å®¹å™¨ï¼Œæ›´é€‚åˆéœ€è¦é«˜åº¦è‡ªåŠ¨åŒ–å’Œå¤§è§„æ¨¡å®¹å™¨ç®¡ç†å’Œå¤æ‚åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†ã€‚

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640.webp)

ç”±æ­¤å¯è§ï¼Œæ— è®ºå•æœº Docker è¿˜æ˜¯æœåŠ¡ç¼–æ’ Docker-composeï¼Œè¿˜æ˜¯é›†ç¾¤è°ƒåº¦ç¼–æ’çš„ Kubernetesï¼Œåœ¨ä¼ä¸šé‡Œé¢æœ‰ç€ç›¸åº”çš„åº”ç”¨åœºæ™¯ï¼Œå‡ ç§éƒ¨ç½²æ¨¡å¼å¹¶å­˜ã€‚é‚£ä¹ˆéšä¹‹è€Œæ¥çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¼ä¸šå¦‚ä½•ç»Ÿä¸€ç®¡ç†é›¶æ•£è¿™äº›ç¯å¢ƒã€‚æ‰€ä»¥ï¼Œä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªèƒ½å¤Ÿç»Ÿä¸€ç®¡ç†è¿™äº›çš„å¹³å°-Portainerã€‚

## **01** portainer ä»‹ç»

ä¸€å¥è¯ä»‹ç» Portainerï¼šèƒ½å¤Ÿå°† Dockerï¼ŒDocker-composeï¼ŒKubernetes ç»Ÿä¸€ç®¡ç†çš„å¹³å°ï¼Œé€šè¿‡ç®€å•æ˜“ç”¨çš„ UI ç•Œé¢ï¼Œæ¶ˆé™¤ä½¿ç”¨ CLIã€ç¼–å†™ YAML çš„å¤æ‚æ€§ã€‚

### ğŸ  é¡¹ç›®ä¿¡æ¯

```bash
# Githubåœ°å€
https://github.com/portainer/portainer
# å®˜ç½‘åœ°å€
https://www.portainer.io/
```

### ğŸš€ åŠŸèƒ½ç‰¹æ€§

- æä¾›ç›´è§‚ç•Œé¢ä½¿ç”¨ Docker çš„å…¨éƒ¨åŠŸèƒ½ï¼Œå¯ä»¥æ„å»ºã€å‘å¸ƒå’Œéƒ¨ç½²å®¹å™¨æ˜ åƒã€ç®¡ç†ç½‘ç»œå’Œå·ï¼Œä»¥åŠé…ç½®è·¨é›†ç¾¤çš„æ‰©å±•ã€‚æ”¯æŒé€šè¿‡ RBACã€æ³¨å†Œè¡¨ç®¡ç†å’Œå¤–éƒ¨èº«ä»½éªŒè¯æ”¯æŒç­‰åŠŸèƒ½ã€‚
- ç›´è§‚çš„ Kubernetes ç®¡ç†å¹³å°ç•Œé¢ï¼Œå…è®¸ç®¡ç†å‘˜å¿«é€Ÿç®¡ç†å’Œç»´æŠ¤é›†ç¾¤ï¼Œæ”¯æŒç®¡ç†é›†ç¾¤çš„æœåŠ¡å¸æˆ·ã€è§’è‰²å’Œè§’è‰²ç»‘å®šï¼Œä»¥åŠé›†ç¾¤è§’è‰²å’Œé›†ç¾¤è§’è‰²ç»‘å®šï¼Œè€Œæ— éœ€é€€å‡ºå‘½ä»¤è¡Œã€‚

### ğŸ›  ç³»ç»Ÿæ¶æ„

Portainer ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šPortainer Server å’Œ Portainer Agentã€‚Portainer Agent éƒ¨ç½²åˆ°é›†éœ€è¦ç®¡ç†çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶åœ¨ Portainer Server ä¸­é…ç½®éœ€è¦çº³ç®¡ç¯å¢ƒçš„ Agent è¿æ¥ä¿¡æ¯ã€‚

**![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166746148-36.webp)**

## 02 portainer å®‰è£…

### Server ç«¯å®‰è£…

é¦–å…ˆï¼Œåˆ›å»º Portainer Server å­˜å‚¨æ•°æ®å·ï¼š

```bash
docker volume create portainer_data
```

ç„¶åï¼Œä¸‹è½½å¹¶è¿è¡Œ Portainer Server å®¹å™¨ï¼š

```bash
docker run -d -p 8000:8000 -p 9443:9443 --name portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce:latest
```

æœ€åï¼Œé€šè¿‡è¿è¡Œ docker ps å‘½ä»¤æ¥æ£€æŸ¥ Portainer Server å®¹å™¨æ˜¯å¦å·²å¯åŠ¨ï¼š

```bash
root@server:~# docker ps
CONTAINER ID   IMAGE                          COMMAND                  CREATED       STATUS      PORTS                                                                                  NAMES
de5b28eb2fa9   portainer/portainer-ce:latest  "/portainer"             2 weeks ago   Up 9 days   0.0.0.0:8000->8000/tcp, :::8000->8000/tcp, 0.0.0.0:9443->9443/tcp, :::9443->9443/tcp   portainer
```

å¯åŠ¨å®Œæˆåï¼Œé€šè¿‡æ‰“å¼€æµè§ˆå™¨è®¿é—® https://localhost:9443 ç™»å½•ï¼Œå¹¶è¿›è¡Œåˆå§‹åŒ–åˆ›å»ºè´¦å·ï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166777151-39.webp)

### Agent ç«¯å®‰è£…

Portainer Agent å®‰è£…åˆ°éœ€è¦çº³ç®¡çš„ Docker ä¸»æœºæˆ–è€… Kubernetes é›†ç¾¤ä¸­ã€‚åœ¨ç•Œé¢é€‰æ‹©åˆ›å»ºç¯å¢ƒï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166777151-40.webp)

é€‰æ‹©éœ€è¦æ·»åŠ çš„å¹³å°ç±»å‹ï¼ˆç°è‰²æ— æ³•é€‰æ‹©çš„ä¸ºä¼ä¸šç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸ç”¨ç®¡ï¼‰ï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166777151-41.webp)

## ä¸€ã€Docker ä¸»æœºæ¥å…¥ç®¡ç†ï¼š

åœ¨éœ€è¦çº³ç®¡çš„ä¸»æœºä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
docker run -d \
  -p 9001:9001 \
  --name portainer_agent \
  --restart=always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /var/lib/docker/volumes:/var/lib/docker/volumes \
  portainer/agent:2.19.4
```

éƒ¨ç½²åï¼Œå°†ä¸»æœºä¿¡æ¯å¡«å…¥ä¸‹å›¾ä¸­ï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166777151-42.webp)

å¡«å…¥åï¼Œå³å¯å¯¹è¿™å° Docker ä¸»æœºè¿›è¡Œç®¡ç†ï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166777151-43.webp)

## äºŒã€Kubernetes é›†ç¾¤æ¥å…¥ç®¡ç†

åœ¨éœ€è¦çº³ç®¡çš„ K8S é›†ç¾¤ä¸­ï¼Œé€‰æ‹© NodePort æˆ–è€… load balancer æ–¹å¼æš´éœ²ç«¯å£ï¼Œé€šè¿‡ Kubectl ä¸Šè¿è¡Œä»¥ä¸‹çš„å‘½ä»¤ï¼š

```bash
# é‡‡ç”¨NodePortæ–¹å¼
kubectl apply -f https://downloads.portainer.io/ce2-19/portainer-agent-k8s-nodeport.yaml
```

éƒ¨ç½²åï¼Œå°†é›†ç¾¤ä¿¡æ¯å¡«å…¥ä¸‹å›¾ä¸­ï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166777151-44.webp)

å¡«å…¥åï¼Œå³å¯å¯¹æ¥å…¥çš„ K8S é›†ç¾¤è¿›è¡Œç®¡ç†ï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166777151-45.webp)

## 03 æœ€å

Portainer ä½œä¸ºæ˜¯ä¸€ä¸ªå¯è§†åŒ–çš„ Docker å’Œ K8S æ“ä½œç•Œé¢ï¼ŒåŠŸèƒ½éå¸¸å…¨é¢ï¼Œæ¯”å¦‚æ”¯æŒé€šè¿‡æ¨¡æ¿å¿«é€Ÿéƒ¨ç½²åº”ç”¨ã€å®¹å™¨é•œåƒç½‘ç»œæ•°æ®å·çš„åŸºæœ¬æ“ä½œã€äº‹ä»¶æ—¥å¿—æ”¶é›†ã€é›†ç¾¤å’Œ SVC ç­‰é›†ä¸­ç®¡ç†å’Œæ“ä½œã€ç»Ÿä¸€ä»“åº“ç®¡ç†ã€ç™»å½•ç”¨æˆ·ç®¡ç†å’Œæƒé™æ§åˆ¶ç­‰åŠŸèƒ½ã€‚è¿™è¾¹å°±ä¸è¿›è¡Œä¸€ä¸€è¯´æ˜å’Œå±•ç¤ºäº†ï¼ŒåŸºæœ¬èƒ½æ»¡è¶³ä¸­å°å‹ä¼ä¸šå¯¹å®¹å™¨å’Œ k8s ç®¡ç†çš„å…¨éƒ¨éœ€æ±‚ã€‚

å”¯ä¸€é—æ†¾çš„æ˜¯å®˜æ–¹æ²¡æœ‰æä¾›ä¸­æ–‡ç•Œé¢ï¼Œä½†æ˜¯æœ‰å¤§ç¥æä¾›äº†ä¸­æ–‡éƒ¨ç½²ç‰ˆæœ¬çš„é•œåƒ

# Kubernetes å®‰å…¨åˆè§„åˆ†æçš„å‘½ä»¤è¡Œå·¥å…·

Kubernetes æˆä¸ºäº†å®¹å™¨ç¼–æ’çš„æ ‡å‡†ã€‚å¾ˆå¤šä¼ä¸šéƒ½é€šè¿‡è‡ªå»ºï¼Œæˆ–è€…äº‘æ‰˜ç®¡çš„æ–¹å¼å»ºè®¾äº† Kubernetes å¹³å°ï¼Œä½†æ˜¯ç”±äº Kubernetes çš„å¤æ‚æ€§ï¼Œå¾ˆå¤šä¼ä¸šåœ¨åŸºäº Kubernetes éƒ¨ç½²ä¸šåŠ¡åº”ç”¨æ—¶ï¼Œä¸ºäº†ä¾¿åˆ©å¹¶æ²¡æœ‰é…ç½®æˆ–è€…å¼€å¯é›†ç¾¤çš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚ç½‘ç»œç­–ç•¥å’Œ Pod å®‰å…¨æ ‡å‡†ç­‰ã€‚å¯¼è‡´ç»å¸¸å‡ºç°ä»¥ä¸‹å¸¸è§çš„å®‰å…¨é—®é¢˜ï¼š

- **æœªæˆæƒè®¿é—®ï¼š**æœªæˆæƒçš„è®¿é—®æ˜¯æœ€å¸¸è§çš„å®‰å…¨é—®é¢˜ä¹‹ä¸€ã€‚åœ¨ Kubernetes ä¸­ï¼Œæœªæˆæƒçš„è®¿é—®å¯èƒ½ä¼šå¯¼è‡´æœªç»æˆæƒçš„ç”¨æˆ·æˆ–ç³»ç»Ÿå¯¹é›†ç¾¤ã€podsã€æœåŠ¡ç­‰èµ„æºè¿›è¡Œæœªæˆæƒçš„æ“ä½œï¼Œå¦‚è®¿é—®ã€ä¿®æ”¹æˆ–åˆ é™¤ç­‰ã€‚
- **æ•æ„Ÿæ•°æ®æš´éœ²ï¼š**æ•æ„Ÿæ•°æ®æš´éœ²æ˜¯æŒ‡ Kubernetes é›†ç¾¤ä¸­çš„æ•æ„Ÿä¿¡æ¯å¦‚å¯†ç ã€API å¯†é’¥ã€è¯ä¹¦ç­‰æœªæ­£ç¡®ä¿æŠ¤ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä¼šè¢«æœªæˆæƒçš„ç”¨æˆ·æˆ–ç³»ç»Ÿè·å–ã€‚
- **å®¹å™¨é€ƒé€¸ï¼š**å®¹å™¨é€ƒé€¸æ˜¯æŒ‡ä¸€ä¸ªå®¹å™¨è¯•å›¾è®¿é—®å¹¶ä¸å±äºå®ƒçš„èµ„æºã€‚åœ¨ Kubernetes ä¸­ï¼Œå®¹å™¨é€ƒé€¸å¯èƒ½ä¼šå¯¼è‡´å®¹å™¨è®¿é—®å®¿ä¸»æœºæˆ–å…¶ä»–å®¹å™¨çš„èµ„æºã€‚
- **ç³»ç»Ÿæƒé™è¿‡é«˜ï¼š**åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒæŸäº›æœåŠ¡æˆ–å®¹å™¨å¯èƒ½ä¼šä»¥ root ç”¨æˆ·æƒé™è¿è¡Œï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æœªæˆæƒçš„ç”¨æˆ·è·å–åˆ°è¿‡é«˜çš„æƒé™ï¼Œä»è€Œå¯èƒ½ä¼šå¯¹å®¿ä¸»æœºé€ æˆå¨èƒã€‚

åŸºäºå¯¹ 2023 CVE ä¸­å…³äº Kubernetes å®‰å…¨é—®é¢˜çš„ç»Ÿè®¡ï¼Œä¸Šè¿°å®‰å…¨é—®é¢˜ä¹Ÿ"é«˜å±…æ¦œé¦–"ã€‚

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-60.webp)

_2023 å¹´ \*Kubernetes\* å¸¸è§æ¼æ´ç±»å‹ï¼ˆæ•°æ®æ¥æºï¼š**cve.mitre.org**ï¼‰_

\*å¤‡æ³¨ï¼š

- _CWE-20ï¼šè¾“å…¥éªŒè¯ä¸å½“_

  _CWE-200ï¼šå°†æ•æ„Ÿä¿¡æ¯æš´éœ²ç»™æœªç»æˆæƒçš„å‚ä¸è€…_

  _CWE-269ï¼šæƒé™ç®¡ç†ä¸å½“_

  _CWE-863ï¼šæˆæƒä¸æ­£ç¡®_

  _CWE-862ï¼šç¼ºå°‘æˆæƒ_

æ® ARMO åˆ†æï¼Œ2018 å¹´è‡³ 2023 å¹´é—´ï¼ŒKubernetes ä¸­çš„æ¼æ´æ•°é‡å¢åŠ äº† 440% ã€‚

_æŠ¥å‘Šåœ°å€ï¼šhttps://www.armosec.io/blog/kubernetes-vulnerabilities-2023/_

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-61.webp)

_Kubernetes æ¼æ´è¶‹åŠ¿ ï¼ˆæ•°æ®æ¥æºï¼šcve.mitre.orgï¼‰_

Kubernetes çš„å®‰å…¨ç®¡ç†æˆä¸ºäº†ä¼ä¸šè¿«åœ¨çœ‰ç«çš„äº‹æƒ…ã€‚å¾ˆå¤šä¼ä¸šä¹Ÿå¼€å§‹é€æ­¥å¼•å…¥ Kubernetes å®‰å…¨æ‰«æå·¥å…·ä»¥æ­¤æ¥æå‡ Kubernetes çš„å®‰å…¨æ€§ã€‚æ‰€ä»¥ä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªèƒ½å¤Ÿé’ˆå¯¹ Kubernetes è¿›è¡Œå…¨é¢å®‰å…¨æ‰«æçš„å·¥å…·-Kubescape

## 01 Kubescape ä»‹ç»

ä¸€å¥è¯ä»‹ç» Kubescapeï¼šä¸€ä¸ªå¼€æº Kubernetes å®‰å…¨æ‰«æå·¥å…·ï¼Œæ”¯æŒ CI/CD ç®¡æµæ°´çº¿ å’Œ IDE é›†æˆï¼Œæ”¯æŒå®‰å…¨é…ç½®åˆ†æã€æ¼æ´æ‰«æã€é£é™©åˆ†æã€å®‰å…¨åˆè§„æ€§åˆ†æç­‰ï¼Œç®€å•æ˜“ç”¨çš„ CLI ç•Œé¢ã€çµæ´»çš„è¾“å‡ºæ ¼å¼ã€‚

### ğŸ  é¡¹ç›®ä¿¡æ¯

```bash
# Githubåœ°å€
https://github.com/kubescape/kubescape
# é¡¹ç›®åœ°å€
https://kubescape.io/
```

### ğŸš€ åŠŸèƒ½ç‰¹æ€§

- æ”¯æŒå®‰å…¨æ‰«æç»“æœå­˜å‚¨åœ¨é›†ç¾¤å†…
- ä» CLI æ‰«æå®¹å™¨é•œåƒä¸­çš„æ¼æ´
- æ”¯æŒæ‰«æé›†ç¾¤ä¸­æ‰€æœ‰é•œåƒçš„æ¼æ´
- æ”¯æŒè®¾ç½®é›†ç¾¤å®‰å…¨æ‰«æåŸºçº¿
- å‘ç°é«˜é£é™©å·¥ä½œè´Ÿè½½ï¼ˆå¦‚æœå—åˆ°å¨èƒï¼Œå¯èƒ½é€ æˆå±å®³çš„å·¥ä½œè´Ÿè½½ï¼‰
- æ”¯æŒ Helm chart éƒ¨ç½²ï¼Œæä¾›è¿ç»­æ‰«æ
- æ”¯æŒç‹¬ç«‹æ˜¾ç¤ºæ¯ä¸ªå·¥ä½œè´Ÿè½½ã€æ¯ä¸ªå‘½åç©ºé—´å’Œæ¯ä¸ªé›†ç¾¤æŒ‡æ ‡
- æ”¯æŒè¾“å‡º Prometheus æ ¼å¼æŒ‡æ ‡
- æ”¯æŒé€šè¿‡ Prometheus Alertmanager å‘å‡ºå‘Šè­¦

### ğŸ”¥ ä½¿ç”¨åœºæ™¯

æ”¯æŒåœ¨ç¼–ç é˜¶æ®µã€CI é˜¶æ®µã€CD é˜¶æ®µã€éƒ¨ç½²é˜¶æ®µè¿›è¡Œæ‰«æã€‚Kubescape Operator è¿˜å¯ä»¥é€šè¿‡ Helm å®‰è£…ã€‚æ”¯æŒè¿ç»­æ‰«æã€é•œåƒæ¼æ´æ‰«æã€è¿è¡Œæ—¶åˆ†æã€ç½‘ç»œç­–ç•¥ç”Ÿæˆç­‰ã€‚Kubescape æ”¯æŒ GitHub Actionã€‚å¾ˆå®¹æ˜“å°† Kubescape é›†æˆåˆ° CI/CD æµæ°´çº¿ä¸­ã€‚

![image-20240508191845661](./Dockerå…¥é—¨.assets/image-20240508191845661.png)

### ğŸ›  ç³»ç»Ÿæ¶æ„

#### ç»„ä»¶æ¶æ„

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-65.webp)

#### å‘½ä»¤è¡Œç•Œé¢

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-66.webp)

#### Operator é€»è¾‘

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-67.webp)

## 02 Kubescape å®‰è£…

### ä¸€ã€å¼€å§‹å®‰è£…

Kubescape çš„æœ€ä½³æ–¹æ³•æ˜¯å°†å…¶ä¸‹è½½åˆ°ç”¨äºç®¡ç† Kubernetes é›†ç¾¤çš„æœºå™¨ä¸Šï¼Œä¸å»ºè®®ç›´æ¥å®‰è£…åˆ° kube-master ä¸Šã€‚

```
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
```

å› ä¸ºä¼šä» Github ä¸‹è½½äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥å¦‚æœç½‘ç»œä¸é€šçš„åŒå­¦ï¼Œéœ€è¦è‡ªè¡Œè§£å†³ Github è®¿é—®é—®é¢˜ï¼Œæˆ–è€…ç›´æ¥åœ¨ Github ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶åæ”¾å…¥ /usr/bin ç›®å½•ã€‚

### äºŒã€ç¦»çº¿ç¯å¢ƒé…ç½®ï¼ˆå¯é€‰ï¼‰

_å¦‚æœå®‰è£… kubescape çš„æœºå™¨å¯ä»¥è®¿é—® Githubï¼Œåˆ™ä¸éœ€è¦è¿™æ­¥_

- ä¸‹è½½æ‰€æœ‰æ‰«ææ ‡å‡†ä¾èµ–

  1.ä¸‹è½½æ‰€æœ‰æ¡†æ¶å¹¶å°†å…¶ä¿å­˜åœ¨æœ¬åœ°ç›®å½•ä¸­ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šè·¯å¾„ï¼Œå°†ä¿å­˜åœ¨`~/.kubescape`.

```
kubescape download artifacts --output path/to/local/dir
```

2.ä½¿ç”¨ä¸‹è½½ç¦»çº¿æ¡†æ¶è¿›è¡Œæ‰«æï¼š

```bash
kubescape scan --use-artifacts-from path/to/local/dir
```

- **ä¸‹è½½å•ä¸ªæ‰«ææ ‡å‡†æ¡†æ¶**

1. ä¸‹è½½å¹¶ä¿å­˜åœ¨æ–‡ä»¶ã€‚å¦‚æœªæŒ‡å®šæ–‡ä»¶ï¼Œå¦å­˜ä¸º `~/.kubescape/<framework name>.json`

```bash
kubescape download framework nsa --output /path/nsa.json
```

2. ä½¿ç”¨ä¸‹è½½çš„æ¡†æ¶è¿›è¡Œæ‰«æï¼š

```bash
kubescape scan framework nsa --use-from /path/nsa.json
```

### ä¸‰ã€æŒç»­æ‰«æç›‘æ§

å¦‚æœéœ€è¦ kubescape æŒç»­çš„æ‰«æç›‘æ§é›†ç¾¤ï¼Œé‚£ä¹ˆå°±éœ€è¦å®‰è£… kubescape Operatorã€‚

```bash
helm repo add kubescape https://kubescape.github.io/helm-charts/ ; helm repo update ; helm upgrade --install kubescape kubescape/kubescape-operator -n kubescape --create-namespace --set clusterName=`kubectl config current-context` --set capabilities.continuousScan=enable
```

éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸï¼š

```bash
$ kubectl get pods -n kubescape
kubescape     kubescape-548d6b4577-qshb5                          1/1     Running   0               60m
kubescape     kubevuln-6779c9d74b-wfgqf                           1/1     Running   0               60m
kubescape     operator-5d745b5b84-ts7zq                           1/1     Running   0               60m
kubescape     storage-59567854fd-hg8n8                            1/1     Running   0               60m
```

## 03 Kubescape ä½¿ç”¨

### ä¸€ã€æ‰«æå‘½ä»¤ä½¿ç”¨

**å¿«é€Ÿæ‰«æï¼š**

```bash
kubescape scan --verbose
```

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-68.webp)

- **ä½¿ç”¨ NSA æ¡†æ¶**æ‰«æ ï¼š

```bash
kubescape scan framework nsa
```

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-69.webp)

- **ä½¿ç”¨ MITRE ATT&CKÂ® æ¡†æ¶æ‰«æï¼š**

```bash
kubescape scan framework mitre
```

- **æ‰«æç‰¹å®šé¡¹**

```bash
kubescape scan control "Privileged container"
```

- **æŒ‡å®š cluster.conf æ‰«æé›†ç¾¤**

```bash
kubescape scan --kubeconfig cluster.conf
```

- **æŒ‡å®šæ‰«æé›†ç¾¤ä¸­æŸäº› namespace**

```bash
kubescape scan --include-namespaces development,staging,production
```

- **æ‰«ææ’é™¤é›†ç¾¤ä¸­æŸäº› namespace**

```bash
kubescape scan --exclude-namespaces kube-system,kube-public
```

- **éƒ¨ç½²å‰æ‰«ææœ¬åœ° YAML/JSON æ–‡ä»¶ï¼š**

```bash
kubescape scan *.yaml
```

- **æ‰«æ Git å­˜å‚¨åº“ä¸­æ¸…å•æ–‡ä»¶ï¼š**

```bash
kubescape scan https://github.com/kubescape/kubescape
```

- **æ‰«æ Helm Charts**

```bash
kubescape scan </path/to/directory>
```

- **æŒ‡å®šæ ¼å¼è¾“å‡º**

```bash
#Jasoæ ¼å¼
kubescape scan --format json --format-version v2 --output results.json
#PDFæ ¼å¼
kubescape scan --format pdf --output results.pdf
#XMLæ ¼å¼
kubescape scan --format junit --output results.xml
#Prometheus metrics
kubescape scan --format prometheus
#htmlæ ¼å¼
kubescape scan --format html --output results.html
```

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-70.webp)

html æŠ¥å‘Š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-71.webp)

pdf æŠ¥å‘Š

### äºŒã€æŒ‡æ ‡è§£è¯»

Kubescape æä¾›ä¸¤ä¸ªé‡è¦æŒ‡æ ‡æ¥è¯„ä¼°åˆè§„æ€§ï¼š

- æ§åˆ¶åˆè§„æ€§åˆ†æ•°ï¼šè¯¥åˆ†æ•°è¡¡é‡æ¡†æ¶å†…å„ä¸ªæ§åˆ¶çš„åˆè§„æ€§ã€‚å®ƒæ˜¯é€šè¿‡è¯„ä¼°ä¼ é€’çš„èµ„æºä¸æ ¹æ®è¯¥æ§åˆ¶è¯„ä¼°çš„èµ„æºæ€»æ•°çš„æ¯”ç‡æ¥è®¡ç®—çš„ã€‚

```bash
kubescape scan --compliance-threshold <SCORE_VALUE[float32]>
```

- æ¡†æ¶åˆè§„æ€§åˆ†æ•°ï¼šæ­¤åˆ†æ•°æä¾›é›†ç¾¤å¯¹ç‰¹å®šæ¡†æ¶åˆè§„æ€§çš„æ€»ä½“è¯„ä¼°ã€‚å®ƒæ˜¯é€šè¿‡è®¡ç®—æ¡†æ¶å†…æ‰€æœ‰æ§åˆ¶çš„æ§åˆ¶åˆè§„æ€§åˆ†æ•°çš„å¹³å‡å€¼æ¥è®¡ç®—çš„ã€‚

```bash
kubescape scan framework <FRAMEWORK_NAME> --compliance-threshold <SCORE_VALUE[float32]>
```

Kubescape æ‰«æå¹¶æä¾›åˆè§„æ€§åˆ†æ•°å¦‚ä¸‹ï¼š

![å›¾ç‰‡](./Dockerå…¥é—¨.assets/640-1715166978780-72.gif)

## 04 æœ€å

ä½œä¸º Kubernetes å®‰å…¨æ‰«æå·¥å…·ï¼ŒKubescape èƒ½å¤Ÿæ”¯æŒåŒ…æ‹¬é£é™©åˆ†æã€å®‰å…¨åˆè§„ã€RBAC è§„èŒƒæ‰«æå’Œå®¹å™¨æ¼æ´æ‰«æç­‰åŠŸèƒ½ã€‚Kubescape æ”¯æŒæ‰«æéƒ¨ç½²å‰çš„ Helm Chartsã€Yaml ç­‰æ–‡ä»¶ï¼Œå’Œæ­£åœ¨è¿è¡Œä¸­çš„ Kubernetes ï¼Œå¹¶ä¸”æä¾›äº†ç®€å•æ˜“ç”¨çš„ CLI ç•Œé¢ï¼Œå¾ˆå®¹æ˜“å’Œ DveOps ã€CI/CD ç­‰é›†æˆï¼Œæå‡ Kubernetes çš„å®‰å…¨åˆè§„èƒ½åŠ›ã€‚

# æ•™ç¨‹

[çº½çº¦å·¥ä½œå®¤ 107 |Dock Lifeï¼šå°† Docker ç”¨äºæ‰€æœ‰äº‹æƒ…ï¼ (nystudio107.com)](https://nystudio107.com/blog/dock-life-using-docker-for-all-the-things)

[å…¨ç½‘å¯¹ Docker å‘½ä»¤æ€»ç»“æœ€å…¨çš„æ–‡ç« ï¼Œç§’æ”¶è—ï¼ (qq.com)](https://mp.weixin.qq.com/s/R2-tFb3uXLp3ZTUvHpSPOA)
