import{_ as s,c as a,o as p,a3 as e}from"./chunks/framework.zGi9i9Bf.js";const u=JSON.parse('{"title":"追踪攻击源头 从IP地址到攻击者身份的溯源之旅","description":"","frontmatter":{},"headers":[],"relativePath":"Document/网络安全/【思路】/追踪攻击源头 从IP地址到攻击者身份的溯源之旅.md","filePath":"Document/网络安全/【思路】/追踪攻击源头 从IP地址到攻击者身份的溯源之旅.md","lastUpdated":1717759497000}'),n={name:"Document/网络安全/【思路】/追踪攻击源头 从IP地址到攻击者身份的溯源之旅.md"},o=e(`<h1 id="追踪攻击源头-从ip地址到攻击者身份的溯源之旅" tabindex="-1">追踪攻击源头 从IP地址到攻击者身份的溯源之旅 <a class="header-anchor" href="#追踪攻击源头-从ip地址到攻击者身份的溯源之旅" aria-label="Permalink to &quot;追踪攻击源头 从IP地址到攻击者身份的溯源之旅&quot;">​</a></h1><h2 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to &quot;背景&quot;">​</a></h2><p>每天在防火墙上会看到攻击者IP，心生好奇，想了解这些攻击者的机器是什么样子，于是就有了这篇文章。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640.webp)</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951177-356.webp)</p><h2 id="信息收集" tabindex="-1">信息收集 <a class="header-anchor" href="#信息收集" aria-label="Permalink to &quot;信息收集&quot;">​</a></h2><p>我使用了简单的 nmap 和 fofa 工具查看了一下。目标机器开放了多个端口，其中有几个是 web 服务，服务器是 Windows。这次的目标只是登录目标服务器查看，不进行其他操作。</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">Nmap</span><span style="color:#98C379;"> scan</span><span style="color:#98C379;"> report</span><span style="color:#98C379;"> for</span><span style="color:#98C379;"> 49.233.xx.xxHost</span><span style="color:#98C379;"> is</span><span style="color:#98C379;"> up</span><span style="color:#ABB2BF;"> (0.18s </span><span style="color:#98C379;">latency</span><span style="color:#ABB2BF;">).Not shown: 990 closed portsPORT      STATE SERVICE            VERSION80/tcp    open  http               Apache httpd135/tcp   open  msrpc              Microsoft Windows RPC139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn443/tcp   open  ssl/https          Apache445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds3389/tcp  open  ssl/ms-wbt-server?49152/tcp open  msrpc              Microsoft Windows RPC49153/tcp open  msrpc              Microsoft Windows RPC49154/tcp open  msrpc              Microsoft Windows RPC49155/tcp open  msrpc              Microsoft Windows RPCService Info: OSs: Windows, Windows Server 2008 R2 - 2012; </span><span style="color:#61AFEF;">CPE:</span><span style="color:#98C379;"> cpe:/o:microsoft:windows</span><span style="color:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#61AFEF;">Service</span><span style="color:#98C379;"> detection</span><span style="color:#98C379;"> performed.</span><span style="color:#98C379;"> Please</span><span style="color:#98C379;"> report</span><span style="color:#98C379;"> any</span><span style="color:#98C379;"> incorrect</span><span style="color:#98C379;"> results</span><span style="color:#98C379;"> at</span><span style="color:#98C379;"> https://nmap.org/submit/</span><span style="color:#98C379;"> .Nm</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951177-357.webp)</p><h2 id="开始" tabindex="-1">开始 <a class="header-anchor" href="#开始" aria-label="Permalink to &quot;开始&quot;">​</a></h2><p>访问该地址的 80 端口时，自动跳转到了一个 Websoft9 的运维页面。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-358.webp)</p><p>我查了一下 Websoft9 这个软件，主要用于提供软件的自动化部署，帮助客户在云服务器上简化企业级软件的安装部署。第一眼看到页面，最先看到的是网站根目录，然后下面的账号密码（这不能是真的吧），然后左侧的功能栏里还有数据库管理、phpinfo功能。看起来，这... 这是在勾引我吗？</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-359.webp)</p><p>好的，试一试也没什么坏处（手动滑稽~）。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-360.webp)</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-361.webp)</p><p>我进去了...在以前看过的公众号实战文章中，经常看到大佬们用弱口令成功登录，我曾经自嘲为什么我就碰不到这样的站。也许是因为我缺乏经验。</p><h2 id="webshell" tabindex="-1">webshell <a class="header-anchor" href="#webshell" aria-label="Permalink to &quot;webshell&quot;">​</a></h2><p>好的，我们可以使用 MySQL 的日志方式来写入一个 webshell。既然我们知道了网站的根目录，我们可以在 MySQL 中执行一些命令来创建一个 webshell 文件。C:\\wwwroot\\。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-362.webp)</p><p>写入后访问时报 not found，怀疑是根路径有问题。于是我通过 Websoft9 自带的 phpinfo 查看 DOCUMENT_ADDR 确认，发现根路径为 C:\\wwwroot\\www.example.com\\。这时我才想起要仔细查看 phpinfo，信息收集在渗透测试中相当重要啊。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-363.webp)</p><p>重新尝试写入 webshell。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-364.webp)</p><p>看来成功了啊，那就太好了！</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-365.webp)</p><p>连接成功了，太好了！</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-366.webp)</p><p>连接成功后查看权限，发现是系统权限，哇，相当高的权限。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-367.webp)</p><p>查看一下是否安装了杀毒软件，结果发现没有安装。</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">wmic</span><span style="color:#98C379;"> /node:localhost</span><span style="color:#98C379;"> /namespace:</span><span style="color:#56B6C2;">\\\\</span><span style="color:#98C379;">root</span><span style="color:#56B6C2;">\\S</span><span style="color:#98C379;">ecurityCenter2</span><span style="color:#98C379;"> path</span><span style="color:#98C379;"> AntiVirusProduct</span><span style="color:#98C379;"> Get</span><span style="color:#98C379;"> DisplayName</span><span style="color:#ABB2BF;"> | </span><span style="color:#61AFEF;">findstr</span><span style="color:#98C379;"> /V</span><span style="color:#98C379;"> /B</span><span style="color:#98C379;"> /C:displayName</span><span style="color:#ABB2BF;"> || </span><span style="color:#56B6C2;">echo</span><span style="color:#98C379;"> No</span><span style="color:#98C379;"> Antivirus</span><span style="color:#98C379;"> installed</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>很抱歉，我无法解读乱码的内容。</p><hr><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">错误：描述</span><span style="color:#98C379;"> =</span><span style="color:#98C379;"> 无效命名空间No</span><span style="color:#98C379;"> Antivirus</span><span style="color:#98C379;"> installed</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>看起来一切都很顺利啊！3389端口是远程桌面协议（RDP）的默认端口，确实是远程连接的端口。</p><h2 id="尝试获取管理员密码" tabindex="-1">尝试获取管理员密码 <a class="header-anchor" href="#尝试获取管理员密码" aria-label="Permalink to &quot;尝试获取管理员密码&quot;">​</a></h2><p>试试上传 procdump64 并导出内存文件 lsass.exe 为 dmp 文件，以尝试获取管理员密码。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-368.webp)</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">procdump64.exe</span><span style="color:#D19A66;"> -accepteula</span><span style="color:#D19A66;"> -ma</span><span style="color:#98C379;"> lsass.exe</span><span style="color:#98C379;"> lsass.dmp</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>下载dmp文件时失败了，可能是因为网速太慢，代理不够好。提醒一下，如果目标主机的网速慢，蚁剑连接、上传/下载文件等操作可能会失败。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-369.webp)</p><p>直接访问该文件进行下载。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-370.webp)</p><p>使用 Mimikatz 进行解析，结果没有找到明文密码，果然失败了。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-371.webp)</p><p>在 Windows Server 2012 R2 Datacenter 上使用 Mimikatz 获取明文密码似乎不太容易，即使是通过 procdump64 导出内存再解析也无法成功。但可以尝试修改注册表来实现。你可以使用以下命令在注册表中新建一个名为 UseLogonCredential 的 DWORD 项，并将其值设置为 1。</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">reg</span><span style="color:#98C379;"> add</span><span style="color:#98C379;"> &quot;HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\SecurityProviders\\WDigest&quot;</span><span style="color:#98C379;"> /v</span><span style="color:#98C379;"> UseLogonCredential</span><span style="color:#98C379;"> /d</span><span style="color:#D19A66;"> 1</span><span style="color:#98C379;"> /t</span><span style="color:#98C379;"> REG_DWORD</span><span style="color:#98C379;"> /f</span></span>
<span class="line"><span style="color:#61AFEF;">看来修改注册表确实有效呢，不错不错！</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-372.webp)</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-373.webp)尝试重载 explorer.exe 进程似乎不太理想，它可能会关闭已经打开的窗口，并且并不能保证注册表的更新成功。</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">taskkill</span><span style="color:#98C379;"> /f</span><span style="color:#98C379;"> /im</span><span style="color:#98C379;"> explorer.exeexplorer.exe</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>更新注册表最可靠的方式可能是重启系统。</p><h2 id="尝试添加新用户" tabindex="-1">尝试添加新用户 <a class="header-anchor" href="#尝试添加新用户" aria-label="Permalink to &quot;尝试添加新用户&quot;">​</a></h2><p>新建用户时没有回显可能让你不确定是否成功。尝试先输入命令，然后检查是否成功。但在尝试远程登录时失败了。起初以为是工具的问题，尝试了另一个工具“哥斯拉”，但结果依然不行。看来问题不在于工具，而是在于我自己。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-374.webp)</p><p>既然尝试了其他方法不行，不妨试试使用 udf 提权的方式。虽然你已经有了 system 权限（捂脸哭），可以尝试使用 MySQL 的 sys_exec() 或者 sys_eval() 来执行命令。确保 MySQL 版本大于 5.1，将 udf.dll 文件放置在 MySQL 安装目录的 lib\\plugin 文件夹下。如果目录不存在，可以新建一个。你可以在 sqlmap 中找到 udf.dll，但需要先解码。解码工具在 sqlmap/extra/cloak/cloak.py，使用以下命令解码：</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">python</span><span style="color:#98C379;"> .</span><span style="color:#56B6C2;">\\c</span><span style="color:#98C379;">loak.py</span><span style="color:#D19A66;"> -d</span><span style="color:#D19A66;"> -i</span><span style="color:#98C379;"> D:</span><span style="color:#56B6C2;">\\t</span><span style="color:#98C379;">ool</span><span style="color:#56B6C2;">\\s</span><span style="color:#98C379;">qlmap</span><span style="color:#56B6C2;">\\d</span><span style="color:#98C379;">ata</span><span style="color:#56B6C2;">\\u</span><span style="color:#98C379;">df</span><span style="color:#56B6C2;">\\m</span><span style="color:#98C379;">ysql</span><span style="color:#56B6C2;">\\w</span><span style="color:#98C379;">indows</span><span style="color:#56B6C2;">\\6</span><span style="color:#98C379;">4</span><span style="color:#56B6C2;">\\l</span><span style="color:#98C379;">ib_mysqludf_sys.dll_</span></span>
<span class="line"><span style="color:#61AFEF;">解码完成后会在</span><span style="color:#D19A66;"> 32</span><span style="color:#98C379;"> 或</span><span style="color:#D19A66;"> 64</span><span style="color:#98C379;"> 位的目录下生成</span><span style="color:#98C379;"> dll</span><span style="color:#98C379;"> 文件。</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在尝试之前，先查看 MySQL 的版本信息，确定需要使用哪个位数的 dll 文件。这个位数不是操作系统的位数，而是 MySQL 软件的位数。还要查看 MySQL 的安装目录位置（phpinfo 中也有）。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-375.webp)</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-376.webp)</p><p>尝试上传 udf.dll 文件到 MySQL 的插件目录。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-377.webp)上传成功后，尝试创建函数。关于为什么不直接使用蚁剑的数据库功能执行语句，可能是因为无法连接上数据库吧！</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">create</span><span style="color:#98C379;"> function</span><span style="color:#98C379;"> sys_exec</span><span style="color:#98C379;"> returns</span><span style="color:#98C379;"> string</span><span style="color:#98C379;"> soname</span><span style="color:#98C379;"> &quot;lib_mysqludf_sys.dll&quot;</span><span style="color:#ABB2BF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>尝试创建用户。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-378.webp)</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951178-379.webp)</p><p>我在靶机（Win7，PHPStudy）上测试了一下，虽然返回 NULL，但用户确实正常添加了。不过，我们不确定用户是否真的被添加了。尝试远程连接一下，看看能不能成功！失败了。之后又尝试了 sys_eval()，虽然可以执行 echo 命令，但 net 命令依然失效。</p><h2 id="copy-net1的绝杀" tabindex="-1">copy net1的绝杀 <a class="header-anchor" href="#copy-net1的绝杀" aria-label="Permalink to &quot;copy net1的绝杀&quot;">​</a></h2><p>看起来 net 命令无法使用了，但在目标系统中有一个文件，是 net1.exe。这让我想起了之前在乌云安全上看到的一篇文章，链接是：<a href="https://mp.weixin.qq.com/s/XLa41N0d4TsOMllgo5QEvQ%E3%80%82%E6%98%AF%E7%9A%84%EF%BC%8C%E9%81%87%E5%88%B0%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8E%E6%96%87%E7%AB%A0%E4%B8%AD%E6%8F%8F%E8%BF%B0%E7%9A%84%E6%83%85%E5%86%B5%E9%9D%9E%E5%B8%B8%E7%9B%B8%E4%BC%BC%EF%BC%8C%E9%83%BD%E6%98%AF%E5%9C%A8" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/XLa41N0d4TsOMllgo5QEvQ。是的，遇到的情况与文章中描述的情况非常相似，都是在</a> Windows Server 2012 系统上，无法使用 net 命令，但具有 system 权限。虽然作者的情况更加复杂，但也可以试着尝试一下。</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951179-380.webp)</p><p>成功了，太好了！</p><p>![图片](./追踪攻击源头 从IP地址到攻击者身份的溯源之旅.assets/640-1714154951179-381.webp)</p><p>关于 net 和 net1 命令的关系，你可以参考以下链接：</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="color:#61AFEF;">https://blog.51cto.com/xxcmd/1151515</span><span style="color:#98C379;">  http://www.safebase.cn/article-124482-1.html</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>本次渗透看起来并不太复杂，比较简单，文章的深度也有限。我观察了一下这台主机，它不太像安全人员使用的主机，反而更像是沦陷的“肉鸡”。不过话说回来，我们在 HW 期间确实有不少人使用自己购买的云主机进行扫描等活动，有些甚至搭建了靶机。我个人认为最好还是为这些活动挂上代理之类的工具，安全人员也要注意自己的安全。</p><p>这次测试纯属运气，一个弱口令解决了太多的问题，直接跳过了 web 方面的测试，我也深深感受到了弱口令带来的危害。</p>`,78),l=[o];function t(r,c,i,d,y,b){return p(),a("div",null,l)}const h=s(n,[["render",t]]);export{u as __pageData,h as default};
