import{_ as a,c as r,o as e,a3 as t}from"./chunks/framework.zGi9i9Bf.js";const o="/ProgramLearnNotes/assets/640-1714243579979-844.BARO9IIa.webp",i="/ProgramLearnNotes/assets/640-1714243579980-845.0KwR3MrS.webp",p="/ProgramLearnNotes/assets/640-1714243579980-846.bcPOpBbr.webp",s="/ProgramLearnNotes/assets/640-1714243579980-847.DoR6VGxM.webp",d="/ProgramLearnNotes/assets/640-1714243579980-848.CAsSqnvj.webp",u=JSON.parse('{"title":"frida入门使用介绍","description":"","frontmatter":{},"headers":[],"relativePath":"Document/网络安全/【逆向破解】/frida入门使用介绍.md","filePath":"Document/网络安全/【逆向破解】/frida入门使用介绍.md","lastUpdated":1714245305000}'),l={name:"Document/网络安全/【逆向破解】/frida入门使用介绍.md"},n=t('<h1 id="frida入门使用介绍" tabindex="-1">frida入门使用介绍 <a class="header-anchor" href="#frida入门使用介绍" aria-label="Permalink to &quot;frida入门使用介绍&quot;">​</a></h1><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>frida是android逆向分析最常用的工具之一，其是一种hook框架，可以在不改动目标源码的情况下，动态查看函数运行入参，返回值，注入代码，更改程序逻辑等，使得android逆向人员能够快速掌握一些问题的本质。本文将带大家了解各种frida的使用方法以及其中的一些坑。</p><p>frida官网：<a href="https://github.com/frida/frida" target="_blank" rel="noreferrer">https://github.com/frida/frida</a></p><h2 id="frida-server的使用方法" tabindex="-1">frida-server的使用方法 <a class="header-anchor" href="#frida-server的使用方法" aria-label="Permalink to &quot;frida-server的使用方法&quot;">​</a></h2><p>frida-server是最常用的一种hook方式。</p><p>**条件：**手机root</p><p>**效果：**无法实现持久化注入，需要依赖于电脑端脚本即时执行</p><p><strong>使用方法：</strong></p><ol><li>从官网下载frida-server-xxx(注意对应版本与架构)</li><li>pip install frida==版本号；pip install frida-tools==版本号（相当于安装电脑客户端，可以不带版本号安装最新版本）；pip install objection</li><li>将下载的frida-server-xxx放入手机端的/data/local/tmp目录下</li><li>chmod 777 frida-server-xxx(这里必须是root权限执行这个操作)</li><li>./frida-server-xxx -P(启动手机端的frida-server)</li><li>frida -U -l xxx.js pid 、frida -U -l xxx.js -n process_name 或者 objection -g process_name explore（进行电脑端连接）</li><li>后续操作手机执行到hook位置即可。</li></ol><p>对于objection可以在连接后加入js文件或者直接输入命令进行hook:</p><p>import xxx.js（引入hook的js文件）</p><p>对于java方法的hook，一般使用命令如下：</p><p>android hooking watch class_method method_name --dump-args --dump-return --dump-backtrace（hook单独一个方法）</p><p>android hooking watch class class_name --dump-args --dump-return --dump-backtrace（hook类下面所有方法）</p><p>**注：**后面三个参数用来表示hook到目标时显示的内容，其依次为显示参数、显示返回值、显示调用栈，可根据自身需求进行添加。</p><p><strong>踩坑点：</strong></p><p>1.objection -g process_name 与frida -U -n process_name这里面的进程名不是ps -A 下的进程名而是frida-ps -U下的进程名（即使这里显示的是中文上面的进程名也需要对应中文才能连接到）</p><p>2.<code>./frida-server-xxx -P</code>中的-P参数是为了更稳定地运行，其主要是防止预加载优化，大多数情况下加上这个参数更好，防止hook时手机崩溃重启等。</p><p>注:为了更稳定地运行，有时可以使用setenforce 0来关闭SELinux安全限制。</p><p>3.objection下的hook（尤其是android hooking命令时）很多时候只针对于已经存在的代码，对于动态加载的代码（甚至一些跨进程调用的代码）都无法找到对应的方法，这时候建议使用frida -U -l xxx.js 的方式去hook特定的方法。</p><p>4.对于有源码的方法来hook时，最好不要使用源码的方法路径进行hook，有时代码会进行混淆，有些方法名等会有一些变化，一般利用jeb等工具逆向后的路径即可。</p><h2 id="frida-gadget用法" tabindex="-1">frida-gadget用法 <a class="header-anchor" href="#frida-gadget用法" aria-label="Permalink to &quot;frida-gadget用法&quot;">​</a></h2><p>frida-gadget主要是针对非root情况下的一种hook方式。</p><p><strong>条件（满足其中一个即可）：</strong></p><ol><li>具有hook应用的签名</li><li>hook的代码与应用的签名权限无关且应用无签名权限也可运行到功能处</li></ol><p>因为frida-gadget需要重新打包apk文件，所以如果没有应用的签名可能会导致功能无法正常完成。</p><p>注：frida-gadget并不需要应用是debuggable，测试应用是否可调试都可以完成hook。</p><p>**效果：**既可以实现持久化注入（在手机端持续运行脚本）也可以远程（在电脑端）运行脚本。</p><h2 id="使用方法" tabindex="-1">使用方法： <a class="header-anchor" href="#使用方法" aria-label="Permalink to &quot;使用方法：&quot;">​</a></h2><p>下面分为两种情况的使用持久化与非持久化</p><h3 id="持久化操作-在手机端运行脚本" tabindex="-1">持久化操作（在手机端运行脚本）： <a class="header-anchor" href="#持久化操作-在手机端运行脚本" aria-label="Permalink to &quot;持久化操作（在手机端运行脚本）：&quot;">​</a></h3><p>1.从官网下载frida-gadget-xxx(注意版本架构对应)并解压出其中的so</p><p>2.将so按照架构放入需要hook的apk的lib目录下的特定目录中</p><p>注:arm64-v8a目录对应arm64;armeabi-v7a目录对应arm；x86目录对应为x86(主要是针对模拟器)。</p><p>3.创建config文件，命名为libfrida-gadget.config.so（命名中的libfrida-gadget与放入libs目录下的so名字保持一致即可）,放入与so相同的目录下。里面的内容示例如下：</p><p><img src="'+o+'" alt="图片"></p><p>其中具体的含义可以参考<a href="https://frida.re/docs/gadget/%E4%B8%AD%E7%9A%84%E8%AF%B4%E6%98%8E%E3%80%82" target="_blank" rel="noreferrer">https://frida.re/docs/gadget/中的说明。</a></p><p>4.将system.loadlibrary(“frida-gadget”)的smali汇编语言注入apk开始的代码位置（一般是启动activity或application开始的位置）。如果apk本身存在加载其他so的代码，也可以利用lief的感染elf文件的功能实现so注入，具体使用方法可参考<a href="https://lief-project.github.io//doc/latest/tutorials/09_frida_lief.html%E3%80%82%E5%8E%9F%E7%90%86%E5%8F%AF%E5%8F%82%E8%80%83https://gslab.qq.com/portal.php?mod=view&amp;aid=163" target="_blank" rel="noreferrer">https://lief-project.github.io//doc/latest/tutorials/09_frida_lief.html。原理可参考https://gslab.qq.com/portal.php?mod=view&amp;aid=163</a></p><p>5.最后对加入so与config和加入特殊smali代码的应用进行打包与重签名。</p><p>6.2—5步是frida-gadget使用的关键步骤，目前网上已经有现成的框架帮忙一次性实现了这几步。</p><p>详细框架及使用方法可参考：</p><p><a href="https://github.com/nszdhd1/UtilScript/tree/main" target="_blank" rel="noreferrer">https://github.com/nszdhd1/UtilScript/tree/main</a></p><p>这个框架本身是利用了lief或者直接在smali代码中插入代码完成so的注入。</p><p>**注：**这里的框架的签名是自己的签名，想要使用自己的证书签名就直接使用signerNew.jar这种工具对生成的未签名的apk进行签名即可。</p><p>7.安装签名后的注入so的应用</p><p>8.将写好的脚本重名为frida_script.js并放入/data/local/tmp目录下（主要与第3步的config配置文件保持一致即可）</p><p>这里给出一个示例脚本：</p><p><img src="'+i+'" alt="图片"></p><p>这个就是hook的Log函数，在打印日志时会多打印Have fun!一个日志。</p><p>**注：**这里打印一定要用Log.e等方法，不要使用console.log，因为这是持久化注入，没有电脑端界面进行显示。</p><p>9.运行到hook的函数位置，通过查看log日志等方式就可看到完成了hook的持久化注入。</p><h3 id="非持久化操作-在电脑端连接引入脚本操作" tabindex="-1">非持久化操作（在电脑端连接引入脚本操作）： <a class="header-anchor" href="#非持久化操作-在电脑端连接引入脚本操作" aria-label="Permalink to &quot;非持久化操作（在电脑端连接引入脚本操作）：&quot;">​</a></h3><p>这个本身与持久化操作大致相同，这里只说明一下其中不同的点：</p><ol><li>config配置文件内容不同，因为这里是需要与电脑端连接，因此需要开放接口，配置文件一般如下：</li></ol><p><img src="'+p+'" alt="图片"></p><p>上面参数的意思主要就是开放127.0.0.1:27042接口进行监听。其中resume是让应用功能正常进行，后续再连接也可。相对的还有一个参数是wait，其意思主要是当应用加载到frida-gadget.so时就会暂时阻塞，等待连接而不进行完整功能。详细的参数意思可以参考官方文档：<a href="https://frida.re/docs/gadget/" target="_blank" rel="noreferrer">https://frida.re/docs/gadget/</a></p><p>上述持久化操作用法中提到的框架在/InjectFrida/tools目录下存在相应的config文件，可以根据自己的需求进行修改。</p><ol start="2"><li>在安装好注入了so的应用后，不需要将js文件放入手机中，在手机端打开存在frida-gadget.so的应用后，可以先利用adb shell netstat -l查看当前手机的接口监听状态，这里如果注入成功应该会发现对应接口（27042）处于监听状态。后续可以利用frida -H 0.0.0.0:27042 -n Gadget -l frida_script.js来进行连接注入js脚本。</li></ol><p>注：这里最好使用0.0.0.0:27042，比较容易连接得到，正常也可以使用127.0.0.1:27042（只要进行了接口转发）也能够进行连接。</p><h3 id="踩坑点" tabindex="-1">踩坑点： <a class="header-anchor" href="#踩坑点" aria-label="Permalink to &quot;踩坑点：&quot;">​</a></h3><p>1.如果是利用框架进行so注入，需要根据自身情况修改里面的配置文件，框架自带的配置文件主要存在于/UtilScript/InjectFrida/tools下，包括config文件、frida-gadget.so、aapt等运行文件，都可以按照自己的实际需求对版本进行修改。</p><p>2.在使用框架时一定要先根据脚本中用到的库进行安装（包括lief），可以自己根据报错进行慢慢补全。同时，根据自己的环境可能脚本运行时会报一些错，一般主要可能是文件路径、文件名一些相关的问题，这里也可以根据报错信息结合自己实际情况进行修改。</p><p>3.对apk签名后安装时可能会遇到一些问题安装不上。一个常见的问题报错如下：</p><p><img src="'+s+'" alt="图片"></p><p>错误有时不会提示30。按照官方解释是如果以 Android 11（API 级别 30）或更高版本为目标平台的应用包含压缩的 resources.arsc 文件或者如果此文件未按 4 字节边界对齐，应用将无法安装。</p><p>这里可以采用zipalign工具来实现对齐,这里要采用先对齐后签名的操作，主要执行命令如下：</p><p><img src="'+d+'" alt="图片"></p><p>这里是一个示例，其中的路径参数以及证书等都可以自行进行替代修改。详细的命令以及使用方法可参考：<a href="https://blog.csdn.net/qq_23045311/article/details/125814795" target="_blank" rel="noreferrer">https://blog.csdn.net/qq_23045311/article/details/125814795</a></p><p>4.最后连接时尽量用命令frida -H 127.0.0.1:27042 -n Gadget -l frida_script.js来进行连接，网络上一些文章解释会使用-U这种USB的连接方式包括frida -U Gadget与frida-ps -U这种方式连接，个人尝试即使进行了端口转化，只有非常偶然的一次连接执行成功，大多数情况下都不太容易完成连接。</p><h3 id="frida-inject使用方法" tabindex="-1">frida-inject使用方法 <a class="header-anchor" href="#frida-inject使用方法" aria-label="Permalink to &quot;frida-inject使用方法&quot;">​</a></h3><p>frida-inject是一种存在于手机端的持久化注入方式，简便好用，依赖安装少。</p><p>**条件：**手机root</p><p>**效果：**只能实现持久化注入，脚本要存在于手机端</p><p><strong>使用方法：</strong></p><ol><li>从官网下载frida-inject-xxx（注意对应的版本与架构）并解压</li><li>将解压后的文件放入手机中的/data/local/tmp目录下</li><li>chmod 777 frida-inject-xxx(对其赋予权限)</li><li>将要运行的js文件同样放入手机中，一般放在与frida-inject-xxx同一个目录下</li><li>./frida-inject-xxx -h可以看见其运行参数说明，后续按照参数说明进程与脚本即可完成持久化注入，这里给一个命令例子：</li></ol><p>./frida-inject-16.1.4-android-arm64 -s frida_script.js -p 5795</p><p>**注：**整个过程很简单，不需要电脑端的python、frida安装或者注入so代码等操作。详细纯手机端完整视频操作可参考<a href="https://www.youtube.com/watch?v=Bnz9mZ7mJsk" target="_blank" rel="noreferrer">https://www.youtube.com/watch?v=Bnz9mZ7mJsk</a></p><p><strong>踩坑点：</strong></p><p>利用这个进行hook时，有时-n app_name会找不到进程导致很难hook到，这里的名字正常是指应用的名字而不是包名，例如有一个应用Test包名为com.example.test这里应该使用Test而不是com.example.test。这里建议还是尽量使用-p pid这种方式，虽然麻烦点，但可以精确到进程。</p><p><strong>总结</strong></p><p>本文主要介绍了frida-server、frida-gadget、frida-inject的环境配置、简单的使用以及踩坑点。关于frida在hook场景下的特殊用法包括方法的主动调用、so库的hook、内存地址的修改查看、特殊参数结果的显示打印等并没有深入探讨，这些更需要在实际需求的情况进行探究学习，读者可以根据<a href="https://frida.re/docs/javascript-api/%E7%9A%84%E4%BB%8B%E7%BB%8D%E8%87%AA%E7%94%B1%E8%BF%9B%E8%A1%8C%E6%89%A9%E5%B1%95%EF%BC%8C%E5%B0%BD%E6%83%85%E9%A2%86%E7%95%A5frida%E5%9C%A8android%E9%80%86%E5%90%91%E4%B8%AD%E7%9A%84%E9%AD%85%E5%8A%9B%E3%80%82" target="_blank" rel="noreferrer">https://frida.re/docs/javascript-api/的介绍自由进行扩展，尽情领略frida在android逆向中的魅力。</a></p>',82),c=[n];function f(h,g,m,_,b,x){return e(),r("div",null,c)}const j=a(l,[["render",f]]);export{u as __pageData,j as default};
